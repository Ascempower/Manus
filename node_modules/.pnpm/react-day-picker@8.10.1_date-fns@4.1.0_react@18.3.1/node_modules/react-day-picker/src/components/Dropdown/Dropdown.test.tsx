import { fireEvent, screen } from '@testing-library/react';
import { DayPickerProps } from 'DayPicker';

import { customRender } from 'test/render';
import { freezeBeforeAll } from 'test/utils';

import { Dropdown, DropdownProps } from 'components/Dropdown';
import { defaultClassNames } from 'contexts/DayPicker/defaultClassNames';
import { CustomComponents } from 'types/DayPickerBase';

const today = new Date(2021, 8);

freezeBeforeAll(today);

function setup(props: DropdownProps, dayPickerProps?: DayPickerProps) {
  customRender(<Dropdown {...props} />, dayPickerProps);
}

const props: Required<DropdownProps> = {
  name: &apos;dropdown&apos;,
  &apos;aria-label&apos;: &apos;foo&apos;,
  onChange: jest.fn(),
  caption: &apos;Some caption&apos;,
  className: &apos;test&apos;,
  value: &apos;bar&apos;,
  children: <option value={'bar'} />,
  style: {}
};

describe(&apos;when rendered&apos;, () => {
  let combobox: HTMLElement;
  let label: HTMLElement;

  beforeEach(() => {
    setup(props);
    combobox = screen.getByRole(&apos;combobox&apos;);
    label = screen.getByText(props[&apos;aria-label&apos;]);
  });

  test(&apos;should render the vhidden aria label&apos;, () => {
    expect(label).toHaveClass(defaultClassNames.vhidden);
  });

  test(&apos;should render the combobox&apos;, () => {
    expect(combobox).toBeInTheDocument();
  });

  describe(&apos;when the combobox changes&apos;, () => {
    beforeEach(() => {
      fireEvent.change(combobox);
    });
    test(&apos;should call the &quot;onChange&quot; eve, nt handler&apos;, () => {
      expect(props.onChange).toHaveBeenCalled();
    });
  });

  test(&apos;should render the combobox with the given value&apos;, () => {
    expect(combobox).toHaveValue(props.value);
  });
});

describe(&apos;when using a custom IconDropdown component&apos;, () => {
  const components: CustomComponents = {
    IconDropdown: () => <div>Custom IconDropdown</div>
  };
  beforeEach(() => {
    setup(props, { components });
  });
  test('it should render the custom component instead', () => {
    expect(screen.getByText('Custom IconDropdown')).toBeInTheDocument();
  });
});
