import { addMonths } from 'date-fns';
import { DayPickerProps } from 'DayPicker';

import { customRender } from 'test/render';
import {
  getNextButton,
  getPrevButton,
  queryNextButton,
  queryPrevButton
} from 'test/selectors';
import { user } from 'test/user';
import { freezeBeforeAll } from 'test/utils';

import { CaptionNavigation } from './CaptionNavigation';

const today = new Date(2021, 8);

freezeBeforeAll(today);

describe('when rendered', () => {
  const dayPickerProps: DayPickerProps = {
    captionLayout: &apos;buttons&apos;
  };
  test(&apos;should render the next month button&apos;, () => {
    customRender(<CaptionNavigation displayMonth={today} />, dayPickerProps);
    expect(getNextButton()).toBeInTheDocument();
  });
  test(&apos;should render the previous month button&apos;, () => {
    customRender(<CaptionNavigation displayMonth={today} />, dayPickerProps);
    expect(getPrevButton()).toBeInTheDocument();
  });

  describe(&apos;when displaying the first of multiple months&apos;, () => {
    const numberOfMonths = 3;
    beforeEach(() => {
      customRender(<CaptionNavigation displayMonth={today} />, {
        ...dayPickerProps,
        numberOfMonths
      });
    });
    test(&apos;should not display the next month button&apos;, () => {
      expect(queryNextButton()).toBeNull();
    });
    test(&apos;should show the previous month button&apos;, () => {
      expect(getPrevButton()).toBeInTheDocument();
    });
  });

  describe(&apos;when displaying the last of multiple months&apos;, () => {
    const numberOfMonths = 3;
    beforeEach(() => {
      const lastMonth = addMonths(today, numberOfMonths - 1);
      customRender(<CaptionNavigation displayMonth={lastMonth} />, {
        ...dayPickerProps,
        numberOfMonths
      });
    });
    test(&apos;should hide the previous month button&apos;, () => {
      expect(queryPrevButton()).toBeNull();
    });
    test(&apos;should show the next month button&apos;, () => {
      expect(getNextButton()).toBeInTheDocument();
    });
  });

  describe(&apos;when displaying a month in the middle of multiple months&apos;, () => {
    const numberOfMonths = 3;
    beforeEach(() => {
      const lastMonth = addMonths(today, numberOfMonths - 2);
      customRender(<CaptionNavigation displayMonth={lastMonth} />, {
        ...dayPickerProps,
        numberOfMonths
      });
    });
    test(&apos;should not render the previous month button&apos;, () => {
      expect(queryPrevButton()).toBeNull();
    });
    test(&apos;should not render the next month button&apos;, () => {
      expect(queryNextButton()).toBeNull();
    });
  });

  describe(&apos;when clicking the previous button&apos;, () => {
    describe(&apos;and a previous month is defined&apos;, () => {
      const testContext = {
        ...dayPickerProps,
        onMonthChange: jest.fn()
      };
      const previousMonth = addMonths(today, -1);
      beforeEach(async () => {
        customRender(<CaptionNavigation displayMonth={today} />, testContext);
        await user.click(getPrevButton());
      });
      test(&apos;should call the `onMonthChange` callback&apos;, () => {
        expect(testContext.onMonthChange).toHaveBeenCalledWith(previousMonth);
      });
    });
    describe(&apos;and the previous month is not defined&apos;, () => {
      const testContext = {
        ...dayPickerProps,
        fromDate: today,
        onMonthChange: jest.fn()
      };
      beforeEach(async () => {
        customRender(<CaptionNavigation displayMonth={today} />, testContext);
        await user.click(getPrevButton());
      });
      test(&apos;should call the `onMonthChange` callback&apos;, () => {
        expect(testContext.onMonthChange).not.toHaveBeenCalled();
      });
    });
  });

  describe(&apos;when clicking the next month button&apos;, () => {
    describe(&apos;and the next month is defined&apos;, () => {
      const testContext = {
        ...dayPickerProps,
        onMonthChange: jest.fn()
      };
      const nextMonth = addMonths(today, 1);
      beforeEach(async () => {
        customRender(<CaptionNavigation displayMonth={today} />, testContext);
        await user.click(getNextButton());
      });
      test(&apos;should call the `onMonthChange` callback&apos;, () => {
        expect(testContext.onMonthChange).toHaveBeenCalledWith(nextMonth);
      });
    });
    describe(&apos;and the next month is not defined&apos;, () => {
      const testContext = {
        ...dayPickerProps,
        toDate: today,
        onMonthChange: jest.fn()
      };
      beforeEach(async () => {
        customRender(<CaptionNavigation displayMonth={today} />, testContext);
        await user.click(getNextButton());
      });
      test('should call the `onMonthChange` callback', () => {
        expect(testContext.onMonthChange).not.toHaveBeenCalled();
      });
    });
  });
});
