import { setISODay } from "../../../setISODay.js";
import { Parser } from "../Parser.js";

import { mapValue, parseNDigits } from "../utils.js";

// ISO day of week
export class ISODayParser extends Parser {
  priority = 90;

  parse(dateString, token, match) {
    const valueCallback = (value) => {
      if (value === 0) {
        return 7;
      }
      return value;
    };

    switch (token) {
      // 2
      case &quot;i&quot;:
      case &quot;ii&quot;: // 02
        return parseNDigits(token.length, dateString);
      // 2nd
      case &quot;io&quot;:
        return match.ordinalNumber(dateString, { unit: &quot;day&quot; });
      // Tue
      case &quot;iii&quot;:
        return mapValue(
          match.day(dateString, {
            width: &quot;abbreviated&quot;,
            context: &quot;formatting&quot;,
          }) ||
            match.day(dateString, {
              width: &quot;short&quot;,
              context: &quot;formatting&quot;,
            }) ||
            match.day(dateString, {
              width: &quot;narrow&quot;,
              context: &quot;formatting&quot;,
            }),
          valueCallback,
        );
      // T
      case &quot;iiiii&quot;:
        return mapValue(
          match.day(dateString, {
            width: &quot;narrow&quot;,
            context: &quot;formatting&quot;,
          }),
          valueCallback,
        );
      // Tu
      case &quot;iiiiii&quot;:
        return mapValue(
          match.day(dateString, {
            width: &quot;short&quot;,
            context: &quot;formatting&quot;,
          }) ||
            match.day(dateString, {
              width: &quot;narrow&quot;,
              context: &quot;formatting&quot;,
            }),
          valueCallback,
        );
      // Tuesday
      case &quot;iiii&quot;:
      default:
        return mapValue(
          match.day(dateString, {
            width: &quot;wide&quot;,
            context: &quot;formatting&quot;,
          }) ||
            match.day(dateString, {
              width: &quot;abbreviated&quot;,
              context: &quot;formatting&quot;,
            }) ||
            match.day(dateString, {
              width: &quot;short&quot;,
              context: &quot;formatting&quot;,
            }) ||
            match.day(dateString, {
              width: &quot;narrow&quot;,
              context: &quot;formatting&quot;,
            }),
          valueCallback,
        );
    }
  }

  validate(_date, value) {
    return value >= 1 && value <= 7;
  }

  set(date, _flags, value) {
    date = setISODay(date, value);
    date.setHours(0, 0, 0, 0);
    return date;
  }

  incompatibleTokens = [
    "y",
    "Y",
    "u",
    "q",
    "Q",
    "M",
    "L",
    "w",
    "d",
    "D",
    "E",
    "e",
    "c",
    "t",
    "T",
  ];
}
