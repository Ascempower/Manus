import { numericPatterns } from "../constants.js";
import { Parser } from "../Parser.js";

import { mapValue, parseNDigits, parseNumericPattern } from "../utils.js";

export class MonthParser extends Parser {
  incompatibleTokens = [
    "Y",
    "R",
    "q",
    "Q",
    "L",
    "w",
    "I",
    "D",
    "i",
    "e",
    "c",
    "t",
    "T",
  ];

  priority = 110;

  parse(dateString, token, match) {
    const valueCallback = (value) => value - 1;

    switch (token) {
      // 1, 2, ..., 12
      case &quot;M&quot;:
        return mapValue(
          parseNumericPattern(numericPatterns.month, dateString),
          valueCallback,
        );
      // 01, 02, ..., 12
      case &quot;MM&quot;:
        return mapValue(parseNDigits(2, dateString), valueCallback);
      // 1st, 2nd, ..., 12th
      case &quot;Mo&quot;:
        return mapValue(
          match.ordinalNumber(dateString, {
            unit: &quot;month&quot;,
          }),
          valueCallback,
        );
      // Jan, Feb, ..., Dec
      case &quot;MMM&quot;:
        return (
          match.month(dateString, {
            width: &quot;abbreviated&quot;,
            context: &quot;formatting&quot;,
          }) ||
          match.month(dateString, { width: &quot;narrow&quot;, context: &quot;formatting&quot; })
        );

      // J, F, ..., D
      case &quot;MMMMM&quot;:
        return match.month(dateString, {
          width: &quot;narrow&quot;,
          context: &quot;formatting&quot;,
        });
      // January, February, ..., December
      case &quot;MMMM&quot;:
      default:
        return (
          match.month(dateString, { width: &quot;wide&quot;, context: &quot;formatting&quot; }) ||
          match.month(dateString, {
            width: &quot;abbreviated&quot;,
            context: &quot;formatting&quot;,
          }) ||
          match.month(dateString, { width: &quot;narrow&quot;, context: &quot;formatting&quot; })
        );
    }
  }

  validate(_date, value) {
    return value >= 0 && value <= 11;
  }

  set(date, _flags, value) {
    date.setMonth(value, 1);
    date.setHours(0, 0, 0, 0);
    return date;
  }
}
